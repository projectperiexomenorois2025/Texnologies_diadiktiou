{% extends "layout.html" %}

{% block title %}{{ playlist.title }} - Streamify{% endblock %}

{% block content %}
<section class="playlist-view-section">
    <div class="container">
        <div class="playlist-header">
            <div>
                <h1 class="playlist-title">{{ playlist.title }}</h1>
                <p class="playlist-creator">
                    Created by <a href="{{ url_for('profile', user_id=playlist.user_id) }}">{{ playlist.creator.username }}</a>
                    {% if not playlist.is_public %}
                        <span class="private-badge"><i class="fas fa-lock"></i> Private</span>
                    {% endif %}
                </p>
            </div>
            
            {% if can_edit %}
                <div class="playlist-actions">
                    <a href="{{ url_for('edit_playlist', playlist_id=playlist.id) }}" class="btn">Edit Playlist</a>
                </div>
            {% endif %}
        </div>
        
        <div class="playlist-container">
            {% if current_video %}
                <div class="playlist-player">
                    <div id="youtube-player" class="youtube-player" data-video-id="{{ current_video.youtube_id }}">
                        <iframe width="100%" height="480" src="https://www.youtube.com/embed/{{ current_video.youtube_id }}?enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    
                    <div class="current-video-info">
                        <h2>{{ current_video.title }}</h2>
                        <p>Added: {{ current_video.added_at.strftime('%B %d, %Y') }}</p>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">This playlist has no videos yet.</div>
            {% endif %}
            
            <div class="playlist-videos">
                <h2>Videos in this Playlist</h2>
                
                {% if not videos %}
                    <p>No videos in this playlist yet.</p>
                {% else %}
                    <div class="video-list">
                        {% for video in videos %}
                            <div class="playlist-video {% if current_video and current_video.youtube_id == video.youtube_id %}playing{% endif %}" 
                                 data-video-id="{{ video.youtube_id }}">
                                <div class="video-thumbnail">
                                    <img src="https://img.youtube.com/vi/{{ video.youtube_id }}/mqdefault.jpg" 
                                         alt="{{ video.title }}">
                                    {% if current_video and current_video.youtube_id == video.youtube_id %}
                                        <div class="now-playing"><i class="fas fa-play"></i> Now Playing</div>
                                    {% endif %}
                                </div>
                                <div class="playlist-video-info">
                                    <h3 class="playlist-video-title">{{ video.title }}</h3>
                                    <p class="playlist-video-date">Added: {{ video.added_at.strftime('%b %d, %Y') }}</p>
                                </div>
                                <div class="playlist-video-actions">
                                    <a href="{{ url_for('view_playlist', playlist_id=playlist.id, video=video.youtube_id) }}" class="btn play-video-btn">
                                        <i class="fas fa-play"></i>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                {% if can_edit %}
                    <div class="add-videos">
                        <a href="{{ url_for('add_video', playlist_id=playlist.id) }}" class="btn btn-primary">Add Videos</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
    .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
    }
    
    .playlist-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .playlist-player {
        position: sticky;
        top: 20px;
    }
    
    .current-video-info {
        margin-top: 1rem;
    }
    
    .playlist-videos {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .video-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .playlist-video {
        display: flex;
        gap: 1rem;
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 0.75rem;
        box-shadow: 0 2px 5px var(--shadow-color);
    }
    
    .video-thumbnail {
        flex: 0 0 120px;
        position: relative;
    }
    
    .video-thumbnail img {
        width: 100%;
        height: auto;
        border-radius: 4px;
    }
    
    .now-playing {
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px 0 4px 0;
    }
    
    .playlist-video-info {
        flex: 1;
    }
    
    .playlist-video-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .playlist-video-date {
        font-size: 0.875rem;
        color: var(--secondary-color);
    }
    
    .playlist-video.playing {
        background-color: var(--primary-color);
        color: white;
    }
    
    .playlist-video.playing .playlist-video-date {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .add-videos {
        margin-top: 1.5rem;
        text-align: center;
    }
    
    @media (max-width: 992px) {
        .playlist-container {
            grid-template-columns: 1fr;
        }
        
        .playlist-player {
            position: relative;
            top: 0;
            margin-bottom: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Load YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    var player;
    
    function onYouTubeIframeAPIReady() {
        const playerContainer = document.getElementById('youtube-player');
        if (!playerContainer) return;
        
        const videoId = playerContainer.getAttribute('data-video-id');
        if (!videoId) return;
        
        player = new YT.Player('youtube-player', {
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }
    
    function onPlayerReady(event) {
        // Player is ready
        console.log('Player ready');
    }
    
    function onPlayerStateChange(event) {
        // When video ends (state=0), play the next video
        if (event.data === 0) {
            playNextVideo();
        }
    }
    
    function playNextVideo() {
        const videos = document.querySelectorAll('.playlist-video');
        let nextVideo = null;
        let found = false;
        
        for (let i = 0; i < videos.length; i++) {
            if (found) {
                nextVideo = videos[i];
                break;
            }
            
            if (videos[i].classList.contains('playing')) {
                found = true;
            }
        }
        
        // If there's a next video, navigate to it
        if (nextVideo) {
            const playBtn = nextVideo.querySelector('.play-video-btn');
            if (playBtn && playBtn.href) {
                window.location.href = playBtn.href;
            }
        } else if (videos.length > 0) {
            // Otherwise loop back to the first video
            const playBtn = videos[0].querySelector('.play-video-btn');
            if (playBtn && playBtn.href) {
                window.location.href = playBtn.href;
            }
        }
    }
</script>
{% endblock %}